<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Legacy AI: Your Joyful Legacy, Powered by AI. Celebrate life, relive memories, and shape the future with AI-curated happiness.">
    <meta name="keywords" content="digital scrapbook, AI storytelling, family memories, joyful moments, interactive legacy, family challenges, memory preservation">
    <meta property="og:title" content="Legacy AI - Celebrate Lifeâ€™s Joyful Moments">
    <meta property="og:description" content="Create vibrant, interactive digital scrapbooks with Legacy AI. Share happy memories and build family adventures for generations.">
    <meta property="og:image" content="https://ailegacy38-netizen.github.io/images/legacy-ai-og.jpg">
    <meta property="og:url" content="https://ailegacy38-netizen.github.io">
    <meta name="twitter:card" content="summary_large_image">
    <title>Legacy AI - Celebrate Lifeâ€™s Joyful Moments</title>
    <link rel="icon" href="/favicon.ico" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NNX53M7SK6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-NNX53M7SK6');
    </script>
    <script src="https://www.paypal.com/sdk/js?client-id=AUy9o-ROuIkc6QG09-CFT8H193u_FCVDqGUq0BbVO4Ge1zVbRQfPCs1YEjSAbUI415dRiUhRgYfzQVUW&currency=USD&components=buttons,marks,card-fields"></script>
    <!-- Firebase SDKs (modular imports) -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged, GoogleAuthProvider, FacebookAuthProvider, TwitterAuthProvider, OAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAI5Sn4rTmQ_un5baTyfduewlqaAiOibiQ",
            authDomain: "life-archive-1ed4a.firebaseapp.com",
            projectId: "life-archive-1ed4a",
            storageBucket: "life-archive-1ed4a.appspot.com",
            messagingSenderId: "999843492181",
            appId: "1:999843492181:web:0defdcd915cd6dd4273fdc",
            measurementId: "G-NNX53M7SK6"
        };
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        // Export services for use in the rest of the script
        window.firebaseServices = {
            app,
            auth: getAuth(app),
            db: getFirestore(app),
            storage: getStorage(app),
            authMethods: {
                signInWithEmailAndPassword,
                createUserWithEmailAndPassword,
                signOut,
                sendPasswordResetEmail,
                onAuthStateChanged,
                signInWithPopup,
                GoogleAuthProvider,
                FacebookAuthProvider,
                TwitterAuthProvider,
                OAuthProvider
            },
            dbMethods: {
                doc, setDoc, getDoc, collection, addDoc, serverTimestamp, updateDoc
            },
            storageMethods: {
                ref: storageRef, uploadBytes, getDownloadURL
            }
        };
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fff3e6;
            color: #333;
        }
        .hero {
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            color: white;
            padding: 120px 0;
            text-align: center;
        }
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }
            .hero p.lead {
                font-size: 1rem;
            }
            .hero .d-grid {
                display: block;
            }
            .hero .d-grid .btn {
                width: 100%;
                margin-bottom: 10px;
            }
        }
        .card {
            border-radius: 15px;
            background: #fff;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: scale(1.05);
        }
        .btn-joyful {
            background-color: #ff6b6b;
            border-color: #ff6b6b;
            color: white;
            font-weight: bold;
        }
        .btn-joyful:hover {
            background-color: #e63946;
            border-color: #e63946;
        }
        .btn-outline-joyful {
            color: #ff6b6b;
            border-color: #ff6b6b;
        }
        .btn-outline-joyful:hover {
            background-color: #ff6b6b;
            color: white;
        }
        .chat-message.user {
            background-color: #ff6b6b;
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 5px;
            align-self: flex-end;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-message.ai {
            background-color: #ffd93d;
            color: #333;
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 5px;
            align-self: flex-start;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-window {
            display: flex;
            flex-direction: column;
            height: 200px;
            border: 1px solid #dee2e6;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
        }
        .footer {
            background: #2c3e50;
            color: #ecf0f1;
        }
        .page-section {
            display: none;
        }
        .page-section.active {
            display: block;
        }
        .client-portal-dashboard {
            display: none;
        }
        .progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        .progress-bar {
            width: 0%;
            height: 20px;
            background-color: #4CAF50;
            text-align: center;
            color: white;
            border-radius: 5px;
            line-height: 20px;
        }
        .modal-body {
            text-align: center;
        }
        .modal-footer {
            justify-content: center;
        }
        .spinner-border {
            display: none;
            width: 3rem;
            height: 3rem;
            margin-top: 15px;
        }
        .py-4.px-3 {
            padding: 1.5rem !important;
        }
        .container {
            padding-left: 15px;
            padding-right: 15px;
        }
        h2.fs-3 {
            font-size: 1.75rem !important;
        }
        .card.p-3 {
            padding: 1rem !important;
        }
        .card h4.fs-5 {
            font-size: 1.25rem !important;
        }
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1050;
        }
        .toast {
            background-color: #333;
            color: white;
        }
        .paypal-buttons-container {
            min-height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        .gpay-button {
            height: 40px;
            width: 100%;
            border-radius: 4px;
            cursor: pointer;
            background-color: black;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }
        .gpay-button svg {
            height: 100%;
        }
        .apple-pay-button {
            height: 40px;
            width: 100%;
            border-radius: 4px;
            cursor: pointer;
            background-color: black;
            display: none;
            -webkit-appearance: -apple-pay-button;
            -apple-pay-button-type: plain;
            -apple-pay-button-style: black;
            margin-top: 10px;
        }
        /* New styles for card fields */
        .card-fields-container {
            margin-top: 10px;
        }
        .card-field {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fff;
        }
        .card-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .card-field-input {
            width: 100%;
            height: 40px;
            border: none;
            outline: none;
        }
        .card-submit-button {
            background-color: #ff6b6b;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .card-submit-button:hover {
            background-color: #e63946;
        }
        /* Social login buttons */
        .social-btn {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: bold;
        }
        .social-btn i {
            font-size: 1.2em;
        }
        .social-btn.google { background-color: #fff; color: #333; border: 1px solid #ddd; }
        .social-btn.facebook { background-color: #3b5998; color: white; }
        .social-btn.twitter { background-color: #1da1f2; color: white; }
        .social-btn.microsoft { background-color: #0078d4; color: white; }
    </style>
</head>
<body>
    <div class="toast-container"></div>
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#" data-page="home">
                <img src="https://firebasestorage.googleapis.com/v0/b/life-archive-1ed4a.appspot.com/o/images%2Flogo.png?alt=media" alt="Legacy AI" class="img-fluid" style="max-height: 40px;" loading="lazy">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#" data-page="home">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-page="moments">Moments That Matter</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-page="challenges">Family Challenges</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-page="pricing">Pricing</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-page="client-portal">Joyful Portal</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            Language
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-lang="en">English</a></li>
                            <li><a class="dropdown-item" href="#" data-lang="es">Spanish</a></li>
                            <li><a class="dropdown-item" href="#" data-lang="fr">French</a></li>
                            <li><a class="dropdown-item" href="#" data-lang="de">German</a></li>
                            <li><a class="dropdown-item" href="#" data-lang="pt">Portuguese</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <section id="home" class="page-section active">
        <div class="hero text-white py-5 px-3 mt-5">
            <div class="container">
                <h1 data-key="home_title" class="fs-2">Capture Lifeâ€™s Joyful Moments with Legacy AI</h1>
                <p class="lead fs-6" data-key="home_lead">Relive the past, celebrate the present, and shape the future with AI-curated happiness. Create Together, Reminisce Forever: Build vibrant digital scrapbooks and happy timelines for generations.</p>
                <div class="d-grid gap-3 d-md-block">
                    <a href="https://firebasestorage.googleapis.com/v0/b/life-archive-1ed4a.appspot.com/o/downloads%2Fjoyful-guide.pdf?alt=media" class="btn btn-outline-light btn-lg w-100 w-md-auto mt-3" download data-key="download_joyful_guide">Download Joyful Memory Guide</a>
                </div>
            </div>
        </div>
        <div class="py-5 bg-light px-3">
            <div class="container">
                <h2 class="text-center mb-4 fs-3" data-key="how_it_works_title">How Legacy AI Spreads Joy</h2>
                <div class="row">
                    <div class="col-md-4 text-center mb-4">
                        <h4 data-key="capture_moments_step" class="fs-5">1. Capture Happy Moments</h4>
                        <p data-key="capture_moments_desc">Upload photos, videos, and voice notes of birthdays, trips, and everyday joys.</p>
                    </div>
                    <div class="col-md-4 text-center mb-4">
                        <h4 data-key="create_adventures_step" class="fs-5">2. Create Family Adventures</h4>
                        <p data-key="create_adventures_desc">AI crafts interactive stories and games starring your loved ones.</p>
                    </div>
                    <div class="col-md-4 text-center mb-4">
                        <h4 data-key="build_timeline_step" class="fs-5">3. Build a Happy Timeline</h4>
                        <p data-key="build_timeline_desc">Organize milestones into a vibrant digital scrapbook for all to cherish.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section id="moments" class="page-section">
        <div class="container py-5 px-3">
            <h2 class="text-center mb-4 fs-3" data-key="moments_title">Moments That Matter</h2>
            <p class="lead text-center" data-key="moments_intro">Relive the joy of birthdays, family trips, inside jokes, and everyday moments. Upload your happiest memories to create a digital scrapbook that sparks smiles.</p>
            <div class="row">
                <div class="col-12 col-sm-6 col-md-4 mb-4">
                    <div class="card p-3 text-center">
                        <h4 data-key="upload_photos_title" class="fs-5">Photos of Joy</h4>
                        <p data-key="upload_photos_desc">Share snapshots of laughter and love.</p>
                        <input type="file" class="form-control mb-2" accept="image/*" id="uploadPhotoInput" multiple>
                        <textarea class="form-control mb-2" id="photoEmotionInput" data-placeholder-key="emotion_tag_placeholder" placeholder="Tag emotions or themes (e.g., #joyful, #adventure)"></textarea>
                        <button class="btn btn-joyful btn-lg w-100" data-key="upload_now" id="uploadPhotoButton">Upload Now</button>
                        <div class="progress-container" id="photoProgressContainer"><div class="progress-bar" id="photoProgressBar">0%</div></div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4 mb-4">
                    <div class="card p-3 text-center">
                        <h4 data-key="record_voice_title" class="fs-5">Voice Notes</h4>
                        <p data-key="record_voice_desc">Capture jokes, songs, or heartfelt messages.</p>
                        <textarea class="form-control mb-2" id="voiceEmotionInput" data-placeholder-key="emotion_tag_placeholder" placeholder="Tag emotions or themes (e.g., #laughter, #wisdom)"></textarea>
                        <button class="btn btn-joyful btn-lg w-100" data-key="record_now" id="recordVoiceButton">Record Now</button>
                        <button class="btn btn-outline-joyful btn-lg w-100 mt-2" data-key="stop_recording" id="stopRecordingButton" style="display: none;">Stop Recording</button>
                        <div class="mt-2" id="recordingTimer" style="display: none;">00:00</div>
                        <audio controls id="audioPreview" class="w-100 mt-2" style="display: none;"></audio>
                        <div class="progress-container" id="voiceProgressContainer"><div class="progress-bar" id="voiceProgressBar">0%</div></div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4 mb-4">
                    <div class="card p-3 text-center">
                        <h4 data-key="share_videos_title" class="fs-5">Happy Videos</h4>
                        <p data-key="share_videos_desc">Upload clips of celebrations and adventures.</p>
                        <input type="file" class="form-control mb-2" accept="video/*" id="uploadVideoInput" multiple>
                        <textarea class="form-control mb-2" id="videoEmotionInput" data-placeholder-key="emotion_tag_placeholder" placeholder="Tag emotions or themes (e.g., #celebration, #travel)"></textarea>
                        <button class="btn btn-joyful btn-lg w-100" data-key="upload_now" id="uploadVideoButton">Upload Now</button>
                        <div class="progress-container" id="videoProgressContainer"><div class="progress-bar" id="videoProgressBar">0%</div></div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section id="challenges" class="page-section">
        <div class="container py-5 px-3">
            <h2 class="text-center mb-4 fs-3" data-key="challenges_title">Interactive Family Challenges</h2>
            <p class="lead text-center" data-key="challenges_intro">Bring your family closer with fun prompts that create joyful memories. Complete challenges and build a positive archive together!</p>
            <div class="row">
                <div class="col-12 col-md-4 mb-4">
                    <div class="card p-4 text-center">
                        <h4 data-key="funny_question_title" class="fs-5">Funny Question Challenge</h4>
                        <p data-key="funny_question_desc">Ask your grandparents one hilarious question today and record their answer!</p>
                        <textarea class="form-control mb-2" id="funnyQuestionResponse" placeholder="Your family's answer..."></textarea>
                        <button class="btn btn-joyful btn-lg w-100" data-key="start_challenge" data-challenge-id="funny-question">Submit Response</button>
                    </div>
                </div>
                <div class="col-12 col-md-4 mb-4">
                    <div class="card p-4 text-center">
                        <h4 data-key="dance_off_title" class="fs-5">Family Dance-Off</h4>
                        <p data-key="dance_off_desc">Record a 60-second family dance-off and share the fun!</p>
                        <input type="file" class="form-control mb-2" accept="video/*" id="danceOffVideoInput">
                        <button class="btn btn-joyful btn-lg w-100" data-key="start_challenge" data-challenge-id="dance-off">Upload Video</button>
                    </div>
                </div>
                <div class="col-12 col-md-4 mb-4">
                    <div class="card p-4 text-center">
                        <h4 data-key="childhood_memory_title" class="fs-5">Childhood Memory Story</h4>
                        <p data-key="childhood_memory_desc">Share a 60-second story of your happiest childhood moment.</p>
                        <textarea class="form-control mb-2" id="childhoodMemoryResponse" placeholder="Your story..."></textarea>
                        <button class="btn btn-joyful btn-lg w-100" data-key="start_challenge" data-challenge-id="childhood-memory">Submit Story</button>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section id="pricing" class="page-section">
        <div class="container py-5 px-3">
            <h2 class="text-center mb-4 fs-3" data-key="pricing_title">Choose Your Joyful Plan</h2>
            <p class="text-center mb-5" data-key="pricing_intro">Start free or unlock premium features to create unforgettable family memories.</p>
            <div id="plan-status" class="alert alert-info text-center" style="display: none;"></div>
            <div class="row row-cols-1 row-cols-md-4 g-4">
                <div class="col">
                    <div class="card h-100 text-center">
                        <div class="card-body">
                            <h3 data-key="free_tier_title">Basic Legacy</h3>
                            <p data-key="free_tier_desc">Limited text & photo archive, AI memory highlights, 5 AI interactions/month.</p>
                            <p class="display-4 fw-bold">$0</p>
                            <button class="btn btn-joyful plan-button" data-key="get_started_free" data-plan="basic">Get Started Free</button>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100 text-center">
                        <div class="card-body">
                            <h3 data-key="essential_tier_title">Essential Legacy</h3>
                            <p data-key="essential_tier_desc">Expanded storage, custom AI persona, multi-language support, mood-based search.</p>
                            <p class="display-4 fw-bold">$15/mo</p>
                            <div class="paypal-buttons-container" id="paypal-essential"></div>
                            <div class="card-fields-container" id="card-fields-essential">
                                <div class="card-field">
                                    <label for="card-number-essential">Card Number</label>
                                    <div id="card-number-essential" class="card-field-input"></div>
                                </div>
                                <div class="card-field">
                                    <label for="card-expiry-essential">Expiration Date</label>
                                    <div id="card-expiry-essential" class="card-field-input"></div>
                                </div>
                                <div class="card-field">
                                    <label for="card-cvv-essential">CVV</label>
                                    <div id="card-cvv-essential" class="card-field-input"></div>
                                </div>
                                <button class="card-submit-button" id="card-submit-essential">Pay with Card</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100 text-center">
                        <div class="card-body">
                            <h3 data-key="family_tier_title">Family Legacy Plus</h3>
                            <p data-key="family_tier_desc">Shared archives, collaborative scrapbooks, unlimited AI interactions, family games.</p>
                            <p class="display-4 fw-bold">$39/mo</p>
                            <div class="paypal-buttons-container" id="paypal-family"></div>
                            <div class="card-fields-container" id="card-fields-family">
                                <div class="card-field">
                                    <label for="card-number-family">Card Number</label>
                                    <div id="card-number-family" class="card-field-input"></div>
                                </div>
                                <div class="card-field">
                                    <label for="card-expiry-family">Expiration Date</label>
                                    <div id="card-expiry-family" class="card-field-input"></div>
                                </div>
                                <div class="card-field">
                                    <label for="card-cvv-family">CVV</label>
                                    <div id="card-cvv-family" class="card-field-input"></div>
                                </div>
                                <button class="card-submit-button" id="card-submit-family">Pay with Card</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100 text-center">
                        <div class="card-body">
                            <h3 data-key="lifetime_tier_title">Lifetime Legacy Vault</h3>
                            <p data-key="lifetime_tier_desc">Unlimited storage, AI legacy book, priority support, scheduled messages, and **exclusive VIP family support with personalized AI memory curations.**</p>
                            <p class="display-4 fw-bold">$299</p>
                            <div class="paypal-buttons-container" id="paypal-lifetime"></div>
                            <div class="card-fields-container" id="card-fields-lifetime">
                                <div class="card-field">
                                    <label for="card-number-lifetime">Card Number</label>
                                    <div id="card-number-lifetime" class="card-field-input"></div>
                                </div>
                                <div class="card-field">
                                    <label for="card-expiry-lifetime">Expiration Date</label>
                                    <div id="card-expiry-lifetime" class="card-field-input"></div>
                                </div>
                                <div class="card-field">
                                    <label for="card-cvv-lifetime">CVV</label>
                                    <div id="card-cvv-lifetime" class="card-field-input"></div>
                                </div>
                                <button class="card-submit-button" id="card-submit-lifetime">Pay with Card</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-5">
                <h3 data-key="one_time_title">Premium Enhancements</h3>
                <p data-key="one_time_desc">Add unique features to your joyful legacy.</p>
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <p data-key="storybook_purchase">AI Storybook ($99)</p>
                        <div class="paypal-buttons-container" id="paypal-storybook"></div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <p data-key="time_capsule_purchase">Time Capsule ($49)</p>
                        <div class="paypal-buttons-container" id="paypal-timecapsule"></div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <p data-key="video_message_purchase">Legacy Video ($79)</p>
                        <div class="paypal-buttons-container" id="paypal-legacyvideo"></div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-5">
                <h3 data-key="business_creator_title">For Businesses & Creators</h3>
                <p data-key="business_creator_desc">Preserve brand stories or create unique AI personas.</p>
                <p data-key="business_plan">Business Plan: $499/year</p>
                <p data-key="creator_plan">Creator Plan: $99 setup + $25/mo</p>
                <p data-key="community_plan">Community Vault: $149/year</p>
                <button class="btn btn-joyful" data-key="contact_sales">Contact Sales</button>
            </div>
            <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="successModalLabel">Success!</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            Your subscription was successful! Welcome to Legacy AI!
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="errorModalLabel">Error</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <span id="errorMessage"></span>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="infoMessageContainer" class="mt-3"></div>
        </div>
    </section>
    <section id="client-portal" class="page-section">
        <div class="container py-5 px-3">
            <div class="client-portal-section" id="login-form">
                <h2 class="text-center mb-4 fs-3" data-key="login_title">Joyful Portal Login</h2>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="clientEmail" class="form-label" data-key="email_label">Email</label>
                        <input type="email" class="form-control" id="clientEmail" data-placeholder-key="email_input_placeholder" placeholder="Email" required>
                    </div>
                    <div class="mb-3">
                        <label for="clientPassword" class="form-label" data-key="password_label">Password</label>
                        <input type="password" class="form-control" id="clientPassword" data-placeholder-key="password_input_placeholder" placeholder="Password" required>
                    </div>
                    <button type="submit" class="btn btn-joyful w-100" data-key="login_button">Login</button>
                    <div class="text-center mt-3">
                        <a href="#" data-key="forgot_password">Forgot Password?</a> | <a href="#" id="showSignup" data-key="signup_link">Sign Up</a>
                    </div>
                    <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
                </form>
                <!-- Social sign-in options -->
                <div class="mt-4">
                    <p class="text-center text-muted mb-3">Or sign in with</p>
                    <button type="button" class="btn social-btn google w-100" id="googleSignIn">
                        <i class="fab fa-google"></i> Sign in with Google
                    </button>
                    <button type="button" class="btn social-btn facebook w-100" id="facebookSignIn">
                        <i class="fab fa-facebook-f"></i> Sign in with Facebook
                    </button>
                    <button type="button" class="btn social-btn twitter w-100" id="twitterSignIn">
                        <i class="fab fa-twitter"></i> Sign in with Twitter
                    </button>
                    <button type="button" class="btn social-btn microsoft w-100" id="microsoftSignIn">
                        <i class="fab fa-microsoft"></i> Sign in with Microsoft
                    </button>
                </div>
            </div>
            <div class="client-portal-section" id="signup-form" style="display: none;">
                <h2 class="text-center mb-4 fs-3" data-key="signup_title">Sign Up for Joyful Portal</h2>
                <form id="signupForm">
                    <div class="mb-3">
                        <label for="signupEmail" class="form-label" data-key="email_label">Email</label>
                        <input type="email" class="form-control" id="signupEmail" data-placeholder-key="email_input_placeholder" placeholder="Email" required>
                    </div>
                    <div class="mb-3">
                        <label for="signupPassword" class="form-label" data-key="password_label">Password</label>
                        <input type="password" class="form-control" id="signupPassword" data-placeholder-key="password_input_placeholder" placeholder="Password" required>
                    </div>
                    <button type="submit" class="btn btn-joyful w-100" data-key="signup_button">Sign Up</button>
                    <div class="text-center mt-3">
                        <a href="#" id="showLogin" data-key="login_link">Already have an account? Login</a>
                    </div>
                    <div id="signupError" class="alert alert-danger mt-3 d-none"></div>
                </form>
                <!-- Added social sign-up options -->
                <div class="mt-4">
                    <p class="text-center text-muted mb-3">Or sign up with</p>
                    <button type="button" class="btn social-btn google w-100" id="googleSignUp">
                        <i class="fab fa-google"></i> Sign up with Google
                    </button>
                    <button type="button" class="btn social-btn facebook w-100" id="facebookSignUp">
                        <i class="fab fa-facebook-f"></i> Sign up with Facebook
                    </button>
                    <button type="button" class="btn social-btn twitter w-100" id="twitterSignUp">
                        <i class="fab fa-twitter"></i> Sign up with Twitter
                    </button>
                    <button type="button" class="btn social-btn microsoft w-100" id="microsoftSignUp">
                        <i class="fab fa-microsoft"></i> Sign up with Microsoft
                    </button>
                </div>
            </div>
            <div class="client-portal-dashboard" id="dashboard-content" style="display: none;">
                <h2 class="mb-4" data-key="welcome_user">Welcome, <span id="userName"></span>!</h2>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card p-4">
                            <h4 data-key="happy_timeline_title" class="fs-5">Your Happy Timeline</h4>
                            <p data-key="happy_timeline_desc">Add milestones, firsts, and joyful moments to your digital scrapbook.</p>
                            <button class="btn btn-joyful" data-key="add_milestone" id="addMilestoneButton">Add Milestone</button>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card p-4">
                            <h4 data-key="bucket_list_title" class="fs-5">Family Bucket List</h4>
                            <p data-key="bucket_list_desc">Set shared goals like trips or fun activities and track progress!</p>
                            <input type="text" class="form-control mb-2" id="goalInput" data-placeholder-key="add_goal_placeholder" placeholder="Add a goal...">
                            <button class="btn btn-joyful" data-key="add_goal" id="addGoalButton">Add Goal</button>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card p-4">
                            <h4 data-key="storytelling_mode_title" class="fs-5">AI Storytelling Adventure</h4>
                            <p data-key="storytelling_mode_desc">Your co-pilot in crafting your familyâ€™s unique journey, creating fun, fictional stories with your loved ones as heroes!</p>
                            <div class="mb-3">
                                <label for="storyCharacters" class="form-label" data-key="story_characters_label">Who are the main characters?</label>
                                <input type="text" class="form-control" id="storyCharacters" data-placeholder-key="story_characters_placeholder" placeholder="e.g., Mom, Dad, Lily, our dog Sparky">
                            </div>
                            <div class="mb-3">
                                <label for="storyTheme" class="form-label" data-key="story_theme_label">Choose a theme:</label>
                                <select class="form-select" id="storyTheme">
                                    <option value="" data-key="select_theme_option">Select a theme</option>
                                    <option value="adventure">Adventure</option>
                                    <option value="mystery">Mystery</option>
                                    <option value="comedy">Comedy</option>
                                </select>
                            </div>
                            <button class="btn btn-joyful" data-key="generate_story" id="generateStoryButton">Generate Story</button>
                            <div class="mt-3" id="storyOutput" style="display: none;"></div>
                            <div class="mt-3" id="storyActions" style="display: none;">
                                <button class="btn btn-joyful me-2" id="saveStoryButton">Save Story</button>
                                <button class="btn btn-outline-joyful me-2" id="shareStoryButton">Share Story</button>
                                <button class="btn btn-outline-joyful" id="regenerateStoryButton">Regenerate</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card p-4">
                            <h4 data-key="challenge_response_title" class="fs-5">Challenge Responses</h4>
                            <p data-key="challenge_response_desc">View and respond to family challenges.</p>
                            <button class="btn btn-joyful" data-key="view_challenges">View Challenges</button>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card p-4">
                            <h4 data-key="account_settings_title" class="fs-5">Account Settings</h4>
                            <p data-key="account_settings_desc">Manage your profile, subscription, and preferences.</p>
                            <button class="btn btn-joyful" data-key="manage_settings">Manage Settings</button>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card p-4">
                            <h4 data-key="contact_support_title" class="fs-5">Support</h4>
                            <p data-key="contact_support_desc">Get help or provide feedback.</p>
                            <button class="btn btn-joyful" data-key="contact_us">Contact Us</button>
                        </div>
                    </div>
                </div>
                <button class="btn btn-outline-joyful w-100 mt-4" id="logoutButton">Logout</button>
            </div>
        </div>
    </section>
    <footer class="footer py-4 px-3">
        <div class="container text-center">
            <p>Â© <span id="current-year"></span> Legacy AI. All rights reserved.</p>
        </div>
    </footer>
    <script type="module">
        // Now use the globally exposed firebaseServices
        const { auth, db, storage, authMethods, dbMethods, storageMethods } = window.firebaseServices;
        const {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            sendPasswordResetEmail,
            onAuthStateChanged,
            signInWithPopup,
            GoogleAuthProvider,
            FacebookAuthProvider,
            TwitterAuthProvider,
            OAuthProvider
        } = authMethods;
        const { doc, setDoc, getDoc, collection, addDoc, serverTimestamp, updateDoc } = dbMethods;
        const { ref: storageRef, uploadBytes, getDownloadURL } = storageMethods;
        let currentLang = 'en';
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob;
        let recordingStartTime;
        let recordingTimerInterval;
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.classList.add('toast');
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        const translations = {
            en: {
                home_title: "Capture Lifeâ€™s Joyful Moments with Legacy AI",
                home_lead: "Relive the past, celebrate the present, and shape the future with AI-curated happiness. Create Together, Reminisce Forever: Build vibrant digital scrapbooks and happy timelines for generations.",
                download_joyful_guide: "Download Joyful Memory Guide",
                how_it_works_title: "How Legacy AI Spreads Joy",
                capture_moments_step: "1. Capture Happy Moments",
                capture_moments_desc: "Upload photos, videos, and voice notes of birthdays, trips, and everyday joys.",
                create_adventures_step: "2. Create Family Adventures",
                create_adventures_desc: "AI crafts interactive stories and games starring your loved ones.",
                build_timeline_step: "3. Build a Happy Timeline",
                build_timeline_desc: "Organize milestones into a vibrant digital scrapbook for all to cherish.",
                moments_title: "Moments That Matter",
                moments_intro: "Relive the joy of birthdays, family trips, inside jokes, and everyday moments. Upload your happiest memories to create a digital scrapbook that sparks smiles.",
                upload_photos_title: "Photos of Joy",
                upload_photos_desc: "Share snapshots of laughter and love.",
                emotion_tag_placeholder: "Tag emotions or themes (e.g., #joyful, #adventure)",
                record_voice_title: "Voice Notes",
                record_voice_desc: "Capture jokes, songs, or heartfelt messages.",
                share_videos_title: "Happy Videos",
                share_videos_desc: "Upload clips of celebrations and adventures.",
                upload_now: "Upload Now",
                record_now: "Record Now",
                stop_recording: "Stop Recording",
                upload_failed: "Upload failed:",
                upload_success: "Voice note uploaded successfully! Converting to MP3.",
                mp3_conversion_failed: "Voice note uploaded, but MP3 conversion failed. Playing WebM.",
                microphone_error: "Microphone access denied or unavailable: ",
                challenges_title: "Interactive Family Challenges",
                challenges_intro: "Bring your family closer with fun prompts that create joyful memories. Complete challenges and build a positive archive together!",
                funny_question_title: "Funny Question Challenge",
                funny_question_desc: "Ask your grandparents one hilarious question today and record their answer!",
                dance_off_title: "Family Dance-Off",
                dance_off_desc: "Record a 60-second family dance-off and share the fun!",
                childhood_memory_title: "Childhood Memory Story",
                childhood_memory_desc: "Share a 60-second story of your happiest childhood moment.",
                start_challenge: "Submit Response",
                pricing_title: "Choose Your Joyful Plan",
                pricing_intro: "Start free or unlock premium features to create unforgettable family memories.",
                free_tier_title: "Basic Legacy",
                free_tier_desc: "Limited text & photo archive, AI memory highlights, 5 AI interactions/month.",
                essential_tier_title: "Essential Legacy",
                essential_tier_desc: "Expanded storage, custom AI persona, multi-language support, mood-based search.",
                family_tier_title: "Family Legacy Plus",
                family_tier_desc: "Shared archives, collaborative scrapbooks, unlimited AI interactions, family games.",
                lifetime_tier_title: "Lifetime Legacy Vault",
                lifetime_tier_desc: "Unlimited storage, AI legacy book, priority support, scheduled messages, and **exclusive VIP family support with personalized AI memory curations.**",
                buy_now: "Buy Now",
                one_time_title: "Premium Enhancements",
                one_time_desc: "Add unique features to your joyful legacy.",
                storybook_purchase: "AI Storybook ($99)",
                time_capsule_purchase: "Time Capsule ($49)",
                video_message_purchase: "Legacy Video ($79)",
                business_creator_title: "For Businesses & Creators",
                business_creator_desc: "Preserve brand stories or create unique AI personas.",
                business_plan: "Business Plan: $499/year",
                creator_plan: "Creator Plan: $99 setup + $25/mo",
                community_plan: "Community Vault: $149/year",
                contact_sales: "Contact Sales",
                login_title: "Joyful Portal Login",
                email_label: "Email",
                email_input_placeholder: "Email",
                password_label: "Password",
                password_input_placeholder: "Password",
                login_button: "Login",
                forgot_password: "Forgot Password?",
                email_required: "Please enter your email address.",
                password_reset_sent: "Password reset email sent! Check your inbox.",
                login_required: "Please login to save a...",
                current_plan: "You are on {{planName}} ðŸ’›",
                welcome_user: "Welcome, !",
                happy_timeline_title: "Your Happy Timeline",
                happy_timeline_desc: "Add milestones, firsts, and joyful moments to your digital scrapbook.",
                add_milestone: "Add Milestone",
                bucket_list_title: "Family Bucket List",
                bucket_list_desc: "Set shared goals like trips or fun activities and track progress!",
                add_goal_placeholder: "Add a goal...",
                add_goal: "Add Goal",
                storytelling_mode_title: "AI Storytelling Adventure",
                storytelling_mode_desc: "Your co-pilot in crafting your familyâ€™s unique journey, creating fun, fictional stories with your loved ones as heroes!",
                story_characters_label: "Who are the main characters?",
                story_characters_placeholder: "e.g., Mom, Dad, Lily, our dog Sparky",
                story_theme_label: "Choose a theme:",
                select_theme_option: "Select a theme",
                generate_story: "Generate Story",
                challenge_response_title: "Challenge Responses",
                challenge_response_desc: "View and respond to family challenges.",
                view_challenges: "View Challenges",
                account_settings_title: "Account Settings",
                account_settings_desc: "Manage your profile, subscription, and preferences.",
                manage_settings: "Manage Settings",
                contact_support_title: "Support",
                contact_support_desc: "Get help or provide feedback.",
                contact_us: "Contact Us",
                logout_button: "Logout",
                demo_timeline_title: "Preview a Happy Timeline",
                demo_timeline_desc: "See how Legacy AI brings memories to life!",
                login_to_create: "Login to Create Your Own",
                signup_title: "Sign Up for Joyful Portal",
                signup_button: "Sign Up",
                signup_link: "Sign Up",
                login_link: "Already have an account? Login"
            },
            es: {
                // Spanish translations (as in original, assuming provided)
                // Add if needed
            },
            fr: {
                upload_now: "TÃ©lÃ©charger Maintenant",
                // ... rest of French translations
            },
            de: {
                // German translations if needed
            },
            pt: {
                // Portuguese translations if needed
            }
        };
        function applyTranslations() {
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (translations[currentLang][key]) {
                    el.textContent = translations[currentLang][key];
                }
            });
            document.querySelectorAll('[data-placeholder-key]').forEach(el => {
                const key = el.getAttribute('data-placeholder-key');
                if (translations[currentLang][key]) {
                    el.placeholder = translations[currentLang][key];
                }
            });
            if (document.getElementById('userName')) {
                document.querySelector('[data-key="welcome_user"]').innerHTML = translations[currentLang].welcome_user.replace('!', '<span id="userName"></span>!');
            }
        }
        document.querySelectorAll('.dropdown-item[data-lang]').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                currentLang = this.getAttribute('data-lang');
                applyTranslations();
            });
        });
        applyTranslations();
        document.querySelectorAll('a[data-page]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.page-section').forEach(section => {
                    section.classList.remove('active');
                });
                const targetPage = this.getAttribute('data-page');
                document.getElementById(targetPage).classList.add('active');
                if (targetPage === 'client-portal') {
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            document.getElementById('login-form').style.display = 'none';
                            document.getElementById('signup-form').style.display = 'none';
                            document.getElementById('dashboard-content').style.display = 'block';
                            document.getElementById('userName').textContent = user.email;
                            updatePlanStatus(user.uid);
                        } else {
                            document.getElementById('login-form').style.display = 'block';
                            document.getElementById('signup-form').style.display = 'none';
                            document.getElementById('dashboard-content').style.display = 'none';
                        }
                    });
                }
            });
        });
        document.getElementById('showSignup').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('signup-form').style.display = 'block';
        });
        document.getElementById('showLogin').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('signup-form').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
        });
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('clientEmail').value;
            const password = document.getElementById('clientPassword').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast('Logged in successfully!', 'success');
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                document.getElementById('userName').textContent = auth.currentUser.email;
                updatePlanStatus(auth.currentUser.uid);
            } catch (error) {
                showToast(`Login failed: ${error.message}`, 'error');
                console.error('Login error:', error);
            }
        });
        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, 'users', userCredential.user.uid), { plan: 'basic' });
                showToast('Signed up successfully!', 'success');
                document.getElementById('signup-form').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                document.getElementById('userName').textContent = auth.currentUser.email;
                updatePlanStatus(auth.currentUser.uid);
            } catch (error) {
                showToast(`Signup failed: ${error.message}`, 'error');
                console.error('Signup error:', error);
            }
        });
        document.getElementById('logoutButton').addEventListener('click', async function(e) {
            e.preventDefault();
            try {
                await signOut(auth);
                showToast('Logged out successfully!', 'info');
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('dashboard-content').style.display = 'none';
            } catch (error) {
                showToast(`Logout failed: ${error.message}`, 'error');
                console.error('Logout error:', error);
            }
        });
        document.querySelector('[data-key="forgot_password"]').addEventListener('click', async function(e) {
            e.preventDefault();
            const email = document.getElementById('clientEmail').value;
            if (email) {
                try {
                    await sendPasswordResetEmail(auth, email);
                    showToast(translations[currentLang].password_reset_sent, 'info');
                } catch (error) {
                    showToast(`Password reset failed: ${error.message}`, 'error');
                    console.error('Password reset error:', error);
                }
            } else {
                showToast(translations[currentLang].email_required, 'error');
            }
        });
        async function updatePlanStatus(userId) {
            const planStatusElement = document.getElementById('plan-status');
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists() && userDoc.data().plan) {
                    const planName = userDoc.data().plan;
                    planStatusElement.textContent = translations[currentLang].current_plan.replace('{{planName}}', planName);
                    planStatusElement.style.display = 'block';
                } else {
                    planStatusElement.style.display = 'none';
                }
            } catch (error) {
                console.error("Error fetching plan status:", error);
                planStatusElement.style.display = 'none';
            }
        }
        async function uploadFile(file, type, emotionTagsInputId, progressBarId, progressContainerId) {
            if (!auth.currentUser) {
                showToast(translations[currentLang].login_required, 'error');
                return;
            }
            const fileRef = storageRef(storage, `${type}s/${auth.currentUser.uid}/${file.name}`);
            const progressBar = document.getElementById(progressBarId);
            const progressContainer = document.getElementById(progressContainerId);
            progressContainer.style.display = 'block';
            try {
                const snapshot = await uploadBytes(fileRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                showToast(`${type} uploaded successfully!`, 'success');
                progressContainer.style.display = 'none';
                const emotionTags = document.getElementById(emotionTagsInputId).value;
                await addDoc(collection(db, 'users', auth.currentUser.uid, type), {
                    fileName: file.name,
                    fileType: file.type,
                    downloadURL: downloadURL,
                    emotionTags: emotionTags,
                    timestamp: serverTimestamp()
                });
                document.getElementById(emotionTagsInputId).value = '';
            } catch (error) {
                showToast(`${translations[currentLang].upload_failed} ${error.message}`, 'error');
                console.error("Upload failed:", error);
                progressContainer.style.display = 'none';
            }
        }
        document.getElementById('uploadPhotoButton').addEventListener('click', function() {
            const fileInput = document.getElementById('uploadPhotoInput');
            if (fileInput.files.length > 0) {
                Array.from(fileInput.files).forEach(file => {
                    uploadFile(file, 'photo', 'photoEmotionInput', 'photoProgressBar', 'photoProgressContainer');
                });
                fileInput.value = '';
            } else {
                showToast('Please select a photo to upload.', 'info');
            }
        });
        document.getElementById('uploadVideoButton').addEventListener('click', function() {
            const fileInput = document.getElementById('uploadVideoInput');
            if (fileInput.files.length > 0) {
                Array.from(fileInput.files).forEach(file => {
                    uploadFile(file, 'video', 'videoEmotionInput', 'videoProgressBar', 'videoProgressContainer');
                });
                fileInput.value = '';
            } else {
                showToast('Please select a video to upload.', 'info');
            }
        });
        document.getElementById('recordVoiceButton').addEventListener('click', async function() {
            if (!auth.currentUser) {
                showToast(translations[currentLang].login_required, 'error');
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                let timerSeconds = 0;
                const recordingTimer = document.getElementById('recordingTimer');
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = async () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audioPreview = document.getElementById('audioPreview');
                    audioPreview.src = audioUrl;
                    audioPreview.style.display = 'block';
                    const fileName = `voice_note_${new Date().getTime()}.webm`;
                    await uploadFile(audioBlob, 'voice', 'voiceEmotionInput', 'voiceProgressBar', 'voiceProgressContainer');
                    clearInterval(recordingTimerInterval);
                    recordingTimer.style.display = 'none';
                    document.getElementById('recordVoiceButton').style.display = 'block';
                    document.getElementById('stopRecordingButton').style.display = 'none';
                };
                mediaRecorder.start();
                recordingStartTime = Date.now();
                recordingTimer.textContent = '00:00';
                recordingTimer.style.display = 'block';
                document.getElementById('recordVoiceButton').style.display = 'none';
                document.getElementById('stopRecordingButton').style.display = 'block';
                recordingTimerInterval = setInterval(() => {
                    timerSeconds = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const minutes = String(Math.floor(timerSeconds / 60)).padStart(2, '0');
                    const seconds = String(timerSeconds % 60).padStart(2, '0');
                    recordingTimer.textContent = `${minutes}:${seconds}`;
                }, 1000);
            } catch (error) {
                showToast(`${translations[currentLang].microphone_error} ${error.message}`, 'error');
                console.error("Microphone access error:", error);
            }
        });
        document.getElementById('stopRecordingButton').addEventListener('click', function() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        });
        document.querySelectorAll('[data-challenge-id]').forEach(button => {
            button.addEventListener('click', async function() {
                if (!auth.currentUser) {
                    showToast(translations[currentLang].login_required, 'error');
                    return;
                }
                const challengeId = this.dataset.challengeId;
                let responseData = {};
                switch (challengeId) {
                    case 'funny-question':
                        responseData.answer = document.getElementById('funnyQuestionResponse').value;
                        if (!responseData.answer) {
                            showToast('Please enter an answer for the funny question challenge.', 'info');
                            return;
                        }
                        break;
                    case 'dance-off':
                        const videoFile = document.getElementById('danceOffVideoInput').files[0];
                        if (!videoFile) {
                            showToast('Please upload a video for the dance-off challenge.', 'info');
                            return;
                        }
                        await uploadFile(videoFile, 'challenge_video', '', 'videoProgressBar', 'videoProgressContainer');
                        responseData.videoUploaded = true;
                        break;
                    case 'childhood-memory':
                        responseData.story = document.getElementById('childhoodMemoryResponse').value;
                        if (!responseData.story) {
                            showToast('Please enter your story for the childhood memory challenge.', 'info');
                            return;
                        }
                        break;
                }
                try {
                    await addDoc(collection(db, 'users', auth.currentUser.uid, 'challenges'), {
                        challengeId: challengeId,
                        responseData: responseData,
                        timestamp: serverTimestamp()
                    });
                    showToast('Challenge response submitted!', 'success');
                    if (challengeId === 'funny-question') document.getElementById('funnyQuestionResponse').value = '';
                    if (challengeId === 'dance-off') document.getElementById('danceOffVideoInput').value = '';
                    if (challengeId === 'childhood-memory') document.getElementById('childhoodMemoryResponse').value = '';
                } catch (error) {
                    showToast(`Challenge submission failed: ${error.message}`, 'error');
                    console.error('Challenge submission error:', error);
                }
            });
        });
        document.getElementById('addMilestoneButton').addEventListener('click', async function() {
            if (!auth.currentUser) {
                showToast(translations[currentLang].login_required, 'error');
                return;
            }
            const milestone = prompt('Enter your milestone:');
            if (milestone) {
                try {
                    await addDoc(collection(db, 'users', auth.currentUser.uid, 'timeline'), {
                        milestone: milestone,
                        timestamp: serverTimestamp()
                    });
                    showToast('Milestone added!', 'success');
                } catch (error) {
                    showToast(`Failed to add milestone: ${error.message}`, 'error');
                }
            }
        });
        document.getElementById('addGoalButton').addEventListener('click', async function() {
            if (!auth.currentUser) {
                showToast(translations[currentLang].login_required, 'error');
                return;
            }
            const goal = document.getElementById('goalInput').value;
            if (goal) {
                try {
                    await addDoc(collection(db, 'users', auth.currentUser.uid, 'bucketList'), {
                        goal: goal,
                        completed: false,
                        timestamp: serverTimestamp()
                    });
                    showToast('Goal added!', 'success');
                    document.getElementById('goalInput').value = '';
                } catch (error) {
                    showToast(`Failed to add goal: ${error.message}`, 'error');
                }
            } else {
                showToast('Please enter a goal.', 'info');
            }
        });
        document.getElementById('generateStoryButton').addEventListener('click', async function() {
            if (!auth.currentUser) {
                showToast(translations[currentLang].login_required, 'error');
                return;
            }
            const characters = document.getElementById('storyCharacters').value;
            const theme = document.getElementById('storyTheme').value;
            if (!characters || !theme) {
                showToast('Please enter characters and select a theme.', 'info');
                return;
            }
            showToast('Generating your story...', 'info');
            const storyOutput = document.getElementById('storyOutput');
            storyOutput.textContent = `Once upon a time, in a land far away, ${characters} embarked on a grand ${theme} adventure... (This is a placeholder story generated by AI.)`;
            storyOutput.style.display = 'block';
            document.getElementById('storyActions').style.display = 'flex';
            showToast('Story generated!', 'success');
        });
        document.getElementById('saveStoryButton').addEventListener('click', async function() {
            if (!auth.currentUser) return;
            const storyContent = document.getElementById('storyOutput').textContent;
            try {
                await addDoc(collection(db, 'users', auth.currentUser.uid, 'stories'), {
                    content: storyContent,
                    timestamp: serverTimestamp()
                });
                showToast('Story saved!', 'success');
            } catch (error) {
                showToast(`Failed to save story: ${error.message}`, 'error');
                console.error('Error saving story:', error);
            }
        });
        document.getElementById('shareStoryButton').addEventListener('click', function() {
            if (!auth.currentUser) return;
            const storyContent = document.getElementById('storyOutput').textContent;
            navigator.clipboard.writeText(storyContent).then(() => {
                showToast('Story copied to clipboard!', 'info');
            }).catch(err => {
                showToast('Failed to copy story.', 'error');
                console.error('Could not copy text: ', err);
            });
        });
        document.getElementById('regenerateStoryButton').addEventListener('click', function() {
            document.getElementById('generateStoryButton').click();
        });
        async function createPayPalOrder(amount, planName) {
            const response = await fetch('https://us-central1-life-archive-1ed4a.cloudfunctions.net/createOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    amount: amount,
                    plan: planName
                })
            });
            if (!response.ok) {
                throw new Error('Failed to create order');
            }
            const data = await response.json();
            return data.id;
        }
        async function onPayPalApprove(data) {
            const response = await fetch('https://us-central1-life-archive-1ed4a.cloudfunctions.net/captureOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    orderID: data.orderID
                })
            });
            if (!response.ok) {
                throw new Error('Failed to capture order');
            }
            const details = await response.json();
            showToast(`Transaction completed!`, 'success');
            if (auth.currentUser) {
                await updateDoc(doc(db, 'users', auth.currentUser.uid), {
                    plan: details.purchase_units[0].reference_id
                });
            }
            return details;
        }
        function onPayPalError(err) {
            showToast(`Payment failed: ${err.message || err}`, 'error');
            console.error('PayPal error:', err);
        }
        function initPayPalButtons(containerId, amount, planName) {
            paypal.Buttons({
                style: {
                    layout: 'vertical',
                    color: 'blue',
                    shape: 'rect',
                    label: 'paypal'
                },
                createOrder: () => createPayPalOrder(amount, planName),
                onApprove: onPayPalApprove,
                onError: onPayPalError
            }).render(`#${containerId}`);
        }
        function initCardFields(containerId, submitButtonId, amount, planName) {
            const cardFields = paypal.CardFields({
                createOrder: () => createPayPalOrder(amount, planName),
                onApprove: onPayPalApprove,
                onError: onPayPalError
            });
            if (cardFields.isEligible()) {
                cardFields.NumberField().render('#card-number-' + containerId.split('-')[1]);
                cardFields.ExpiryField().render('#card-expiry-' + containerId.split('-')[1]);
                cardFields.CVVField().render('#card-cvv-' + containerId.split('-')[1]);
                document.getElementById(submitButtonId).addEventListener('click', () => {
                    cardFields.submit().catch(onPayPalError);
                });
            } else {
                document.getElementById(containerId).style.display = 'none';
            }
        }
        // Social authentication handler (for both sign-in and sign-up)
        async function handleSocialAuth(provider, isSignup = false) {
            try {
                const result = await signInWithPopup(auth, provider);
                const action = isSignup ? 'signed up' : 'logged in';
                showToast(`Successfully ${action}!`, 'success');

                // Ensure the user has the basic plan (merge to avoid overwriting existing data)
                await setDoc(doc(db, 'users', result.user.uid), { plan: 'basic' }, { merge: true });

                document.getElementById('login-form').style.display = 'none';
                document.getElementById('signup-form').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                document.getElementById('userName').textContent = result.user.email || result.user.displayName || 'User';
                updatePlanStatus(result.user.uid);
            } catch (error) {
                if (error.code === 'auth/popup-closed-by-user') {
                    // Silent if user closes popup
                    return;
                }
                showToast(`Authentication failed: ${error.message}`, 'error');
                console.error('Social auth error:', error);
            }
        }

        // Sign-in buttons
        document.getElementById('googleSignIn')?.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            handleSocialAuth(provider, false);
        });
        document.getElementById('facebookSignIn')?.addEventListener('click', () => {
            const provider = new FacebookAuthProvider();
            handleSocialAuth(provider, false);
        });
        document.getElementById('twitterSignIn')?.addEventListener('click', () => {
            const provider = new TwitterAuthProvider();
            handleSocialAuth(provider, false);
        });
        document.getElementById('microsoftSignIn')?.addEventListener('click', () => {
            const provider = new OAuthProvider('microsoft.com');
            handleSocialAuth(provider, false);
        });

        // Sign-up buttons (newly added)
        document.getElementById('googleSignUp')?.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            handleSocialAuth(provider, true);
        });
        document.getElementById('facebookSignUp')?.addEventListener('click', () => {
            const provider = new FacebookAuthProvider();
            handleSocialAuth(provider, true);
        });
        document.getElementById('twitterSignUp')?.addEventListener('click', () => {
            const provider = new TwitterAuthProvider();
            handleSocialAuth(provider, true);
        });
        document.getElementById('microsoftSignUp')?.addEventListener('click', () => {
            const provider = new OAuthProvider('microsoft.com');
            handleSocialAuth(provider, true);
        });

        document.addEventListener('DOMContentLoaded', () => {
            initPayPalButtons('paypal-essential', '15.00', 'Essential');
            initCardFields('card-fields-essential', 'card-submit-essential', '15.00', 'Essential');
            initPayPalButtons('paypal-family', '39.00', 'Family Plus');
            initCardFields('card-fields-family', 'card-submit-family', '39.00', 'Family Plus');
            initPayPalButtons('paypal-lifetime', '299.00', 'Lifetime');
            initCardFields('card-fields-lifetime', 'card-submit-lifetime', '299.00', 'Lifetime');
            initPayPalButtons('paypal-storybook', '99.00', 'AI Storybook');
            initPayPalButtons('paypal-timecapsule', '49.00', 'Time Capsule');
            initPayPalButtons('paypal-legacyvideo', '79.00', 'Legacy Video');
            document.getElementById('current-year').textContent = new Date().getFullYear();
        });
    </script>
</body>
</html>
